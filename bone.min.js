/*!
 * VERSION: 0.2.0
 * DATE: 2015-03-31
 * GIT:https://github.com/shrekshrek/bone
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;"function"==typeof define&&define.amd?define(["exports"],function(n){e.Bone=t(e,n)}):"undefined"!=typeof exports?t(e,exports):e.Bone=t(e,{})}(function(t,e){var n=t.Bone,i=[].slice;e.VERSION="0.2.0",e.noConflict=function(){return t.Bone=n,this};var r=function(t){return"function"==typeof t||!1},s=function(t){return Function.prototype.bind.apply(t,i.call(arguments,1))};e.bind=s;var a=function(t){var e=arguments.length;if(2>e||null==t)return t;for(var n=1;e>n;n++)for(var i=arguments[n],r=o(i),s=r.length,a=0;s>a;a++){var h=r[a];t[h]=i[h]}return t};e.extend=a;var o=function(t){var e=[];for(var n in t)e.push(n);return e},h=function(t){return null==t?0:void 0!==t.length?t.length:o(t).length},c=function(t){return null==t?!0:void 0!==t.length?0===t.length:0===o(t).length},l=0,u=function(t){var e=++l+"";return t?t+e:e},f=e.Events={},g=/\s+/,p=function(t,e,n,i,r){var s,a=0;if(n&&"object"==typeof n){void 0!==i&&"context"in r&&void 0===r.context&&(r.context=i);for(s=o(n);a<s.length;a++)e=t(e,s[a],n[s[a]],r)}else if(n&&g.test(n))for(s=n.split(g);a<s.length;a++)e=t(e,s[a],i,r);else e=t(e,n,i,r);return e};f.on=function(t,e,n){return v(this,t,e,n)};var v=function(t,e,n,i,r){if(t._events=p(d,t._events||{},e,n,{context:i,ctx:t,listening:r}),r){var s=t._listeners||(t._listeners={});s[r.id]=r}return t};f.listenTo=function(t,e,n){if(!t)return this;var i=t._listenId||(t._listenId=u("l")),r=this._listeningTo||(this._listeningTo={}),s=r[i];if(!s){var a=this._listenId||(this._listenId=u("l"));s=r[i]={obj:t,objId:i,id:a,listeningTo:r,count:0}}return v(t,e,n,this,s),this};var d=function(t,e,n,i){if(n){var r=t[e]||(t[e]=[]),s=i.context,a=i.ctx,o=i.listening;o&&o.count++,r.push({callback:n,context:s,ctx:s||a,listening:o})}return t};f.off=function(t,e,n){return this._events?(this._events=p(_,this._events,t,e,{context:n,listeners:this._listeners}),this):this},f.stopListening=function(t,e,n){var i=this._listeningTo;if(!i)return this;for(var r=t?[t._listenId]:o(i),s=0;s<r.length;s++){var a=i[r[s]];if(!a)break;a.obj.off(e,n,this)}return c(i)&&(this._listeningTo=void 0),this};var _=function(t,e,n,i){if(t){var r,s=0,a=i.context,c=i.listeners;if(e||n||a){for(var l=e?[e]:o(t);s<l.length;s++){e=l[s];var u=t[e];if(!u)break;for(var f=[],g=0;g<u.length;g++){var p=u[g];n&&n!==p.callback&&n!==p.callback._callback||a&&a!==p.context?f.push(p):(r=p.listening,r&&0===--r.count&&(delete c[r.id],delete r.listeningTo[r.objId]))}f.length?t[e]=f:delete t[e]}return h(t)?t:void 0}for(var v=o(c);s<v.length;s++)r=c[v[s]],delete c[r.id],delete r.listeningTo[r.objId]}};f.once=function(t,e,n){var i=p(y,{},t,e,s(this.off,this));return this.on(i,void 0,n)},f.listenToOnce=function(t,e,n){var i=p(y,{},e,n,s(this.stopListening,this,t));return this.listenTo(t,i)};var y=function(t,e,n,i){if(n){var r=t[e]=function(){i(e,r),n.apply(this,arguments)};r._callback=n}return t};f.trigger=function(t){if(!this._events)return this;for(var e=Math.max(0,arguments.length-1),n=Array(e),i=0;e>i;i++)n[i]=arguments[i+1];return p(m,this._events,t,void 0,n),this};var m=function(t,e,n,i){if(t){var r=t[e],s=t.all;r&&s&&(s=s.slice()),r&&b(r,i),s&&b(s,[e].concat(i))}return t},b=function(t,e){var n,i=-1,r=t.length,s=e[0],a=e[1],o=e[2];switch(e.length){case 0:for(;++i<r;)(n=t[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=t[i]).callback.call(n.ctx,s);return;case 2:for(;++i<r;)(n=t[i]).callback.call(n.ctx,s,a);return;case 3:for(;++i<r;)(n=t[i]).callback.call(n.ctx,s,a,o);return;default:for(;++i<r;)(n=t[i]).callback.apply(n.ctx,e);return}};a(e,f);var x=e.Class=function(){this.initialize.apply(this,arguments)};a(x.prototype,f,{initialize:function(){}});var w=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},k=/\((.*?)\)/g,S=/(\(\?)?:\w+/g,P=/\*\w+/g,H=/[\-{}\[\]+?.,\\\^$|#\s]/g;a(w.prototype,f,{initialize:function(){},route:function(t,n,i){t=this._routeToRegExp(t),r(n)&&(i=n,n=""),i||(i=this[n]);var s=this;return e.history.route(t,function(r){var a=s._extractParameters(t,r);s.execute(i,a,n)!==!1&&(s.trigger.apply(s,["route:"+n].concat(a)),s.trigger("route",n,a),e.history.trigger("route",s,n,a))}),this},execute:function(t,e){t&&t.apply(this,e)},navigate:function(t,n){return e.history.navigate(t,n),this},_bindRoutes:function(){if(this.routes)for(var t,e=o(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])},_routeToRegExp:function(t){return t=t.replace(H,"\\$&").replace(k,"(?:$1)?").replace(S,function(t,e){return e?t:"([^/?]+)"}).replace(P,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1),i=[];for(var r in n){var s=n[r];i[r]=r===n.length-1?s||null:s?decodeURIComponent(s):null}return i}});var U=e.History=function(){this.handlers=[],this.checkUrl=s(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},C=/^[#\/]|\s+$/g,I=/^\/+|\/+$/g,R=/#.*$/;U.started=!1,a(U.prototype,f,{atRoot:function(){var t=this.location.pathname.replace(/[^\/]$/,"$&/");return t===this.root&&!this.getSearch()},matchRoot:function(){var t=this.decodeFragment(this.location.pathname),e=t.slice(0,this.root.length-1)+"/";return e===this.root},decodeFragment:function(t){return decodeURI(t.replace(/%25/g,"%2525"))},getSearch:function(){var t=this.location.href.replace(/#.*/,"").match(/\?.+/);return t?t[0]:""},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getPath:function(){var t=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===t.charAt(0)?t.slice(1):t},getFragment:function(t){return null==t&&(t=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),t.replace(C,"")},start:function(t){if(U.started)throw new Error("Bone.history has already been started");if(U.started=!0,this.options=a({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window,this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(I,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var e=this.root.slice(0,-1)||"/";return this.location.replace(e+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}var n=window.addEventListener||function(t,e){return attachEvent("on"+t,e)};return this._usePushState?n("popstate",this.checkUrl,!1):this._useHashChange&&n("hashchange",this.checkUrl,!1),this.options.silent?void 0:this.loadUrl()},stop:function(){var t=window.removeEventListener||function(t,e){return detachEvent("on"+t,e)};this._usePushState?t("popstate",this.checkUrl,!1):this._useHashChange&&t("hashchange",this.checkUrl,!1),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),U.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){console.log(this);var t=this.getFragment();return t===this.fragment?!1:void this.loadUrl()},loadUrl:function(t){if(!this.matchRoot())return!1;t=this.fragment=this.getFragment(t);for(var e in this.handlers){var n=this.handlers[e];if(n.route.test(t))return n.callback(t),!0}},navigate:function(t,e){if(!U.started)return!1;e&&e!==!0||(e={trigger:!!e}),t=t.replace(R,"");var n=this.root;(""===t||"?"===t.charAt(0))&&(n=n.slice(0,-1)||"/");var i=n+t;if(t=this.decodeFragment(t.replace(R,"")),this.fragment!==t){if(this.fragment=t,this._usePushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,t,e.replace)}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}}),e.history=new U;var T=function(t,e){var n,i=this;n=t&&Object.prototype.hasOwnProperty.call(t,"constructor")?t.constructor:function(){return i.apply(this,arguments)},a(n,i,e);var r=function(){this.constructor=n};return r.prototype=i.prototype,n.prototype=new r,t&&a(n.prototype,t),n.__super__=i.prototype,n};return w.extend=U.extend=x.extend=T,e});
