/*!
 * VERSION: 0.1.0
 * DATE: 2015-03-31
 * GIT:https://github.com/shrekshrek/bone
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t,e){"function"==typeof define&&define.amd?define(["jquery","exports"],function(i,n){t.Bone=e(t,n,i)}):t.Bone=e(t,{},t.jQuery||t.Zepto||t.$)}(this,function(t,e,i){var n=t.Bone;e.VERSION="0.1.0",e.$=i,e.noConflict=function(){return t.Bone=n,this};var r=[],s=r.slice,o=function(t){return Function.prototype.bind.apply(t,s.call(arguments,1))};e.bind=o;var a=function(t){var e=arguments.length;if(2>e||null==t)return t;for(var i=1;e>i;i++){var n=arguments[i];for(var r in n)t[r]=n[r]}return t};e.extend=a;var h=function(t,e){var i,n=this;i=t&&Object.prototype.hasOwnProperty.call(t,"constructor")?t.constructor:function(){return n.apply(this,arguments)},a(i,n,e);var r=function(){this.constructor=i};return r.prototype=n.prototype,i.prototype=new r,t&&a(i.prototype,t),i.__super__=n.prototype,i},u=0,c=e.Events={on:function(t,e,i){if(!t||!e)return this;this._events||(this._events={});var n=this._events[t]||(this._events[t]=[]);return n.push({callback:e,context:i,ctx:i||this}),this},once:function(t,e,i){if(!t||!e)return this;var n=this,r=function(){n.off(t,r,i),e.apply(this,arguments)};return r._callback=e,this.on(t,r,i)},off:function(t,e,i){if(!this._events)return this;var n,r,s,o;if(!t&&!e&&!i)return this._events={},this;var a=this;o=t?[t]:function(){var t=[];for(var e in a._events)t.push(e);return t}();for(var h=o.length-1;h>=0;h--)if(t=o[h],s=this._events[t]){if(this._events[t]=n=[],e||i)for(var u=s.length-1;u>=0;u--)r=s[u],(e&&e!==r.callback&&e!==r.callback._callback||i&&i!==r.context)&&n.push(r);n.length||delete this._events[t]}},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1),i=this._events[t];return i&&l(i,e),this},listenTo:function(t,e,i){var n=this._listeningTo||(this._listeningTo={}),r=t._listenId||(t._listenId=++u);return n[r]=t,t.on(e,i,this),this},listenToOnce:function(t,e,i){var n=this._listeningTo||(this._listeningTo={}),r=t._listenId||(t._listenId=++u);return n[r]=t,t.once(e,i,this),this},stopListening:function(t,e,i){var n=this._listeningTo;if(!n)return this;var r=!e&&!i;i||"object"!=typeof e||(i=this),t&&((n={})[t._listenId]=t);for(var s in n){t=n[s],t.off(e,i,this);var o=0;for(var a in t._events)o++;(r||!o)&&delete this._listeningTo[s]}return this}},l=function(t,e){for(var i=t.length-1;i>=0;i--)t[i].callback.apply(t[i].ctx,e)};a(e,c);var f=e.Class=function(){this.initialize.apply(this,arguments)};a(f.prototype,c,{initialize:function(){}});var v=0,p=/^(\S+)\s*(.*)$/,g=["el","id","attributes","className","tagName"],d=e.View=function(t){this.cid=++v,t||(t={});for(var e in g)t[g[e]]&&(this[g[e]]=t[g[e]]);this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()};a(d.prototype,c,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t){return this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],this},delegateEvents:function(t){if(!t&&!(t=this.events))return this;this.undelegateEvents();for(var e in t){var i=t[e];if("function"!=typeof i&&(i=this[t[e]]),i){var n=e.match(p),r=n[1],s=n[2];i=o(i,this),r+=".delegateEvents"+this.cid,""===s?this.$el.on(r,i):this.$el.on(r,s,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(this.el);else{var t=a({},this.attributes);this.id&&(t.id=this.id),this.className&&(t["class"]=this.className);var i=e.$("<"+this.tagName+">").attr(t);this.setElement(i)}}});var _=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},m=/\((.*?)\)/g,y=/(\(\?)?:\w+/g,$=/\*\w+/g,w=/[\-{}\[\]+?.,\\\^$|#\s]/g;a(_.prototype,c,{initialize:function(){},route:function(t,i){t=this._routeToRegExp(t),"string"==typeof i&&(i=this[i]);var n=this;return e.history.route(t,function(r){var s=n._extractParameters(t,r);n.execute(i,s),n.trigger("route",s),e.history.trigger("route",n,s)}),this},execute:function(t,e){t&&t.apply(this,e)},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes)for(var t in this.routes)this.route(t,this.routes[t])},_routeToRegExp:function(t){return t=t.replace(w,"\\$&").replace(m,"(?:$1)?").replace(y,function(t,e){return e?t:"([^/?]+)"}).replace($,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1),n=[];for(var r in i){var s=i[r];n[r]=r===i.length-1?s||null:s?decodeURIComponent(s):null}return n}});var x=e.History=function(){this.handlers=[],this.checkUrl=o(this.checkUrl,this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},b=/^[#\/]|\s+$/g,E=/^\/+|\/+$/g,k=/#.*$/;return x.started=!1,a(x.prototype,c,{atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t){return null==t&&(t=this.getHash()),t.replace(b,"")},start:function(t){if(x.started)throw new Error("Bone.history has already been started");x.started=!0,this.options=a({root:"/"},this.options,t),this.root=this.options.root;var i=this.getFragment();return this.root=("/"+this.root+"/").replace(E,"/"),e.$(window).on("hashchange",this.checkUrl),this.fragment=i,this.options.silent?void 0:this.loadUrl()},stop:function(){e.$(window).off("hashchange",this.checkUrl),x.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment?!1:void this.loadUrl()},loadUrl:function(t){t=this.fragment=this.getFragment(t);for(var e in this.handlers){var i=this.handlers[e];if(i.route.test(t))return i.callback(t),!0}},navigate:function(t,e){return x.started?(e&&e!==!0||(e={trigger:!!e}),t=t.replace(k,""),this.fragment!==t?(this.fragment=t,this._updateHash(this.location,t,e.replace),e.trigger?this.loadUrl(t):void 0):void 0):!1},_updateHash:function(t,e,i){if(i){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),e.history=new x,_.extend=x.extend=d.extend=f.extend=h,e});
